<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Progress Dashboard</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  <script src="worksheet-tracking.js"></script>
  <!-- Add Chart.js before our scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Navigation */
    .main-navigation {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--accent-color, #4A9EFF);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 70px;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .nav-logo img {
      height: 40px;
      width: auto;
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 30px;
    }

    .nav-link {
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      padding: 10px 15px;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-link:hover {
      background: rgba(74, 158, 255, 0.1);
      color: var(--accent-color, #4A9EFF);
    }

    .nav-link.active {
      background: var(--accent-color, #4A9EFF);
      color: white;
    }

    /* Main container */
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Header */
    .dashboard-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 40px;
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(74, 158, 255, 0.05) 100%);
      border: 2px solid var(--accent-color, #4A9EFF);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .dashboard-header h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--accent-color, #4A9EFF);
    }

    .dashboard-header p {
      font-size: 1.1rem;
      color: #cccccc;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Grid layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .sidebar-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .sidebar-card h3 {
      color: var(--accent-color, #4A9EFF);
      margin-bottom: 20px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Form styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #ffffff;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color, #4A9EFF);
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-color, #4A9EFF), #3a8ce6);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(74, 158, 255, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #2196F3, #1976D2);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      gap: 15px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-label {
      color: #cccccc;
      font-size: 14px;
    }

    .stat-value {
      color: var(--accent-color, #4A9EFF);
      font-weight: 700;
      font-size: 16px;
    }

    /* Export buttons */
    .export-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .export-btn {
      width: 100%;
      justify-content: center;
    }

    /* Main content */
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .content-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 30px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .content-card h2 {
      color: var(--accent-color, #4A9EFF);
      margin-bottom: 25px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* Chart section */
    .chart-section {
      min-height: 400px;
    }

    .chart-container {
      height: 350px;
      width: 100%;
      position: relative;
      margin-top: 20px;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* Worksheets grid */
    .worksheets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
    }

    .worksheet-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .worksheet-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      border-color: var(--accent-color, #4A9EFF);
    }

    .worksheet-card.completed {
      border-left: 4px solid var(--accent-color, #4A9EFF);
      background: linear-gradient(135deg, rgba(74, 158, 255, 0.1) 0%, rgba(74, 158, 255, 0.05) 100%);
    }

    .worksheet-card.incomplete {
      border-left: 4px solid #ff9800;
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%);
    }

    .worksheet-card.not-started {
      border-left: 4px solid #666;
      background: linear-gradient(135deg, rgba(102, 102, 102, 0.1) 0%, rgba(102, 102, 102, 0.05) 100%);
    }

    .worksheet-title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #ffffff;
    }

    .worksheet-type {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
    }

    .worksheet-type.maintenance {
      background: rgba(74, 158, 255, 0.2);
      color: var(--accent-color, #4A9EFF);
      border: 1px solid rgba(74, 158, 255, 0.3);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.5s ease;
      border-radius: 4px;
    }

    .progress-fill.completed {
      background: linear-gradient(90deg, var(--accent-color, #4A9EFF), #3a8ce6);
    }

    .progress-fill.incomplete {
      background: linear-gradient(90deg, #ff9800, #ffb74d);
    }

    .progress-fill.not-started {
      background: linear-gradient(90deg, #666, #888);
    }

    .worksheet-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #cccccc;
      margin-top: 15px;
    }

    .last-activity {
      font-size: 0.8rem;
      color: #999999;
      margin-top: 8px;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        order: 2;
      }
      
      .main-content {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        padding: 20px 15px;
      }
      
      .dashboard-header {
        padding: 30px 20px;
      }
      
      .dashboard-header h1 {
        font-size: 2rem;
      }
      
      .worksheets-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-menu {
        gap: 15px;
      }
      
      .nav-link {
        font-size: 12px;
        padding: 8px 12px;
      }
    }

    @media (max-width: 480px) {
      .nav-container {
        flex-direction: column;
        height: auto;
        padding: 15px;
        gap: 15px;
      }
      
      .nav-menu {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* File input styling */
    .file-input-wrapper {
      position: relative;
      margin: 15px 0;
    }

    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: block;
      width: 100%;
      text-align: center;
    }

    /* Reset controls */
    .reset-controls {
      margin-top: 20px;
    }

    .reset-options {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reset-options.show {
      display: flex;
    }

    /* Import status */
    #importStatus {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }

    /* Chart fallback */
    #chartFallback {
      display: none;
      text-align: center;
      padding: 50px;
      color: #cccccc;
    }

    #chartFallback i {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--accent-color, #4A9EFF);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo" onclick="window.location='index.html'" title="Go to Home">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
      </div>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.location='index.html'" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp2388-worksheets.html'" class="nav-link">
            <i class="fas fa-cogs"></i> CP2388
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='tracking-dashboard.html'" class="nav-link active">
            <i class="fas fa-chart-line"></i> PROGRESS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='about.html'" class="nav-link">
            <i class="fas fa-info-circle"></i> ABOUT
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
      <h1><i class="fas fa-chart-line"></i> Progress Dashboard</h1>
      <p>Track your progress across all worksheets and export results for your teacher</p>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Student Information -->
        <div class="sidebar-card">
          <h3><i class="fas fa-user"></i> Student Information</h3>
          <form id="studentForm">
            <div class="form-group">
              <label for="studentName">Student Name</label>
              <input type="text" id="studentName" placeholder="Enter your name">
            </div>
            <div class="form-group">
              <label for="studentId">Student ID</label>
              <input type="text" id="studentId" placeholder="Enter your student ID">
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Save Information
            </button>
          </form>
        </div>

        <!-- Quick Stats -->
        <div class="sidebar-card">
          <h3><i class="fas fa-tachometer-alt"></i> Quick Stats</h3>
          <div class="stats-grid" id="quickStats">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Export Progress -->
        <div class="sidebar-card">
          <h3><i class="fas fa-download"></i> Export Progress</h3>
          <p style="margin-bottom: 20px; color: #cccccc; font-size: 14px;">
            Export your progress report:
          </p>
          <div class="export-buttons">
            <button class="btn btn-secondary export-btn" onclick="exportToJSON()">
              <i class="fas fa-file-code"></i> Export as JSON
            </button>
            <button class="btn btn-secondary export-btn" onclick="exportToCSV()">
              <i class="fas fa-file-csv"></i> Export as CSV
            </button>
            <button class="btn btn-danger export-btn" onclick="exportToPDF()">
              <i class="fas fa-file-pdf"></i> Export as PDF
            </button>
          </div>
          
          <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="color: var(--accent-color, #4A9EFF); margin-bottom: 15px; font-size: 1rem;">
              <i class="fas fa-upload"></i> Import Progress
            </h4>
            <p style="margin-bottom: 15px; color: #cccccc; font-size: 14px;">
              Import from a previous export:
            </p>
            <div class="file-input-wrapper">
              <input type="file" id="importFile" class="file-input" accept=".json" onchange="importProgressData(this)">
              <label for="importFile" class="btn btn-secondary file-input-label">
                <i class="fas fa-upload"></i> Choose JSON File
              </label>
            </div>
            <div id="importStatus"></div>
          </div>

          <!-- Reset Section -->
          <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <h4 style="color: #f44336; margin-bottom: 15px; font-size: 1rem;">
              <i class="fas fa-trash-alt"></i> Reset Progress
            </h4>
            <p style="margin-bottom: 15px; color: #cccccc; font-size: 14px;">
              Reset all worksheet progress (this cannot be undone):
            </p>
            <div class="reset-controls">
              <button onclick="showResetOptions()" class="btn btn-danger" id="initialResetBtn">
                <i class="fas fa-trash-alt"></i> Reset All Progress
              </button>
              <div id="resetOptions" class="reset-options">
                <button onclick="exportAndReset()" class="btn btn-secondary">
                  <i class="fas fa-download"></i> Export & Reset
                </button>
                <button onclick="resetProgress()" class="btn btn-danger">
                  <i class="fas fa-exclamation-triangle"></i> Confirm Reset
                </button>
                <button onclick="hideResetOptions()" class="btn btn-primary">
                  <i class="fas fa-times"></i> Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Progress Charts -->
        <div class="content-card chart-section">
          <h2><i class="fas fa-chart-bar"></i> Progress Overview</h2>
          <div class="chart-container">
            <canvas id="progressChart"></canvas>
            <div id="chartFallback">
              <i class="fas fa-chart-bar"></i>
              <p>Loading progress chart...</p>
            </div>
          </div>
        </div>

        <!-- Maintenance Worksheets -->
        <div class="content-card">
          <h2><i class="fas fa-cogs"></i> Maintenance Worksheets (CP2388) <span id="maintenanceCount" style="color: #cccccc; font-size: 0.9rem;">0/12</span></h2>
          <div class="worksheets-grid" id="maintenanceWorksheets">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let progressChart = null; // Global reference to chart instance

    // Load settings and apply accent color
    function loadSettings() {
      try {
        const settings = JSON.parse(localStorage.getItem('app-settings') || '{}');
        if (settings.appAccent) {
          document.documentElement.style.setProperty('--accent-color', settings.appAccent);
        }
      } catch (error) {
        console.warn('Could not load settings:', error);
      }
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Check if worksheetTracker is available
      if (typeof worksheetTracker === 'undefined') {
        console.error('WorksheetTracker not loaded');
        return;
      }
      
      if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        return;
      }
      
      // Wait a moment for DOM to be fully ready
      setTimeout(() => {
        // Initialize dashboard components
        initializeDashboard();
        initializeCharts();
        
        // Set up refresh button
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', function() {
            updateQuickStats();
            updateWorksheetsDisplay();
            initializeCharts();
          });
        }
      }, 100);
    });

    function initializeDashboard() {
      loadStudentInfo();
      updateQuickStats();
      updateWorksheetsDisplay();
    }

    function updateQuickStats() {
      try {
        const stats = worksheetTracker.getOverallProgress();
        const quickStatsDiv = document.getElementById('quickStats');
        
        if (!quickStatsDiv) {
          console.error('Quick stats div not found');
          return;
        }
        
        quickStatsDiv.innerHTML = `
          <div class="stat-item">
            <span class="stat-label">Overall Progress</span>
            <span class="stat-value">${stats.completionPercentage || 0}%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Completed Worksheets</span>
            <span class="stat-value">${stats.completedWorksheets || 0}/${stats.totalWorksheets || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Questions Answered</span>
            <span class="stat-value">${stats.completedQuestions || 0}/${stats.totalQuestions || 0}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Last Activity</span>
            <span class="stat-value">${formatLastActivity(stats.lastActivity)}</span>
          </div>
        `;
      } catch (error) {
        console.error('Error updating quick stats:', error);
      }
    }

    function formatLastActivity(lastActivity) {
      if (!lastActivity) return 'Never';
      try {
        const date = new Date(lastActivity);
        if (isNaN(date.getTime()) || date > new Date()) return 'Never';
        return date.toLocaleDateString();
      } catch (error) {
        console.warn('Error formatting date:', error);
        return 'Never';
      }
    }

    function initializeCharts() {
      try {
        console.log('Initializing charts...');
        
        const canvas = document.getElementById('progressChart');
        const fallback = document.getElementById('chartFallback');
        
        if (!canvas) {
          console.error('Progress chart canvas not found');
          if (fallback) {
            fallback.style.display = 'block';
            fallback.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Chart canvas not found</p>';
          }
          return;
        }
        
        console.log('Canvas found:', canvas);
        console.log('Canvas dimensions:', canvas.width, 'x', canvas.height);

        // Set explicit canvas dimensions to ensure visibility
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        console.log('Set canvas dimensions to:', canvas.width, 'x', canvas.height);

        // Show fallback initially
        if (fallback) {
          fallback.style.display = 'block';
        }

        const ctx = canvas.getContext('2d');
        const allProgress = worksheetTracker.getAllProgress();
        
        console.log('All progress:', allProgress);
        
        // Prepare data for chart
        if (!worksheetTracker.worksheets || !worksheetTracker.worksheets.maintenance) {
          console.error('Worksheets data not available for chart');
          if (fallback) {
            fallback.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Worksheets data not available</p>';
          }
          return;
        }
        
        console.log('Worksheets available:', worksheetTracker.worksheets.maintenance);
        
        const maintenanceData = worksheetTracker.worksheets.maintenance.map(worksheet => {
          const progress = allProgress[`maintenance-${worksheet.id}`] || { completionPercentage: 0 };
          return progress.completionPercentage || 0;
        });
        
        console.log('Maintenance data:', maintenanceData);

        // Destroy existing chart if it exists
        if (progressChart instanceof Chart) {
          console.log('Destroying existing chart...');
          progressChart.destroy();
        }
        
        console.log('Creating new chart...');
        progressChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: worksheetTracker.worksheets.maintenance.map(w => `WS ${w.id}`),
            datasets: [{
              label: 'Completion %',
              data: maintenanceData,
              backgroundColor: function(context) {
                const value = context.raw || 0;
                if (value === 0) return '#666';
                if (value === 100) return getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
                return '#ff9800';
              },
              borderColor: '#333',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            resizeDelay: 0,
            animation: {
              duration: 0
            },
            layout: {
              padding: {
                left: 10,
                right: 30,
                top: 10,
                bottom: 10
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: '#333'
                },
                ticks: {
                  color: '#aaa',
                  callback: value => value + '%'
                }
              },
              x: {
                grid: {
                  color: '#333'
                },
                ticks: {
                  color: '#aaa'
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                enabled: true,
                position: 'nearest',
                z: 1,
                callbacks: {
                  label: function(context) {
                    return `Completion: ${context.raw || 0}%`;
                  }
                }
              }
            }
          }
        });
        
        console.log('Chart created successfully');
        
        // Hide fallback on success
        if (fallback) {
          fallback.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error initializing chart:', error);
        
        // Show error in fallback
        const fallback = document.getElementById('chartFallback');
        if (fallback) {
          fallback.style.display = 'block';
          fallback.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>Error loading chart: ' + error.message + '</p>';
        }
      }
    }

    function updateWorksheetsDisplay() {
      try {
        const allProgress = worksheetTracker.getAllProgress();
        
        // Update maintenance worksheets
        const maintenanceContainer = document.getElementById('maintenanceWorksheets');
        const maintenanceCount = document.getElementById('maintenanceCount');
        
        if (!maintenanceContainer) {
          console.error('Maintenance container not found');
          return;
        }
        
        let maintenanceCompleted = 0;
        
        if (worksheetTracker.worksheets && worksheetTracker.worksheets.maintenance) {
          maintenanceContainer.innerHTML = worksheetTracker.worksheets.maintenance.map(worksheet => {
            const progress = allProgress[`maintenance-${worksheet.id}`] || {
              completedQuestions: 0,
              totalQuestions: worksheet.totalQuestions,
              completionPercentage: 0
            };
            
            const isComplete = progress.completedQuestions === progress.totalQuestions;
            const statusClass = progress.completedQuestions === 0 ? 'not-started' : 
                              isComplete ? 'completed' : 'incomplete';
            
            if (isComplete) maintenanceCompleted++;
            
            return `
              <div class="worksheet-card ${statusClass}" onclick="openWorksheet('maintenance', ${worksheet.id})">
                <div class="worksheet-title">${worksheet.title}</div>
                <span class="worksheet-type maintenance">Maintenance</span>
                <div class="progress-bar">
                  <div class="progress-fill ${statusClass}" style="width: ${progress.completionPercentage || 0}%"></div>
                </div>
                <div class="worksheet-stats">
                  <span>${progress.completedQuestions || 0}/${progress.totalQuestions} questions</span>
                  <span>${progress.completionPercentage || 0}%</span>
                </div>
                ${progress.lastUpdated ? `<div class="last-activity">Last updated: ${new Date(progress.lastUpdated).toLocaleString()}</div>` : ''}
              </div>
            `;
          }).join('');
          
          // Update count if element exists
          if (maintenanceCount) {
            maintenanceCount.textContent = `${maintenanceCompleted}/${worksheetTracker.worksheets.maintenance.length}`;
          }
        } else {
          console.error('Worksheets data not available');
          maintenanceContainer.innerHTML = '<p style="color: #cccccc; text-align: center; padding: 20px;">Worksheets data not available</p>';
          if (maintenanceCount) {
            maintenanceCount.textContent = '0/0';
          }
        }
      } catch (error) {
        console.error('Error updating worksheets display:', error);
      }
    }

    function openWorksheet(type, id) {
      if (type === 'maintenance') {
        window.location.href = `worksheet-${id}.html`;
      }
    }

    function loadStudentInfo() {
      try {
        const studentInfo = worksheetTracker.getStudentInfo();
        const nameInput = document.getElementById('studentName');
        const idInput = document.getElementById('studentId');
        
        if (nameInput && idInput) {
          nameInput.value = studentInfo.name || '';
          idInput.value = studentInfo.id || '';
        }
      } catch (error) {
        console.error('Error loading student info:', error);
      }
    }

    // Student form submission
    document.getElementById('studentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('studentName').value;
      const id = document.getElementById('studentId').value;
      
      worksheetTracker.setStudentInfo(name, id);
      
      // Show success message
      const saveBtn = document.querySelector('#studentForm .btn-primary');
      if (saveBtn) {
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saved!';
        saveBtn.style.background = 'var(--accent-color)';
        
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '';
        }, 2000);
      }
    });

    // Export functions
    function exportToJSON() {
      worksheetTracker.exportToJSON();
    }

    function exportToCSV() {
      worksheetTracker.exportToCSV();
    }

    function exportToPDF() {
      worksheetTracker.exportToPDF();
    }

    // Import function
    function importProgressData(input) {
      const file = input.files[0];
      if (!file) return;

      const statusDiv = document.getElementById('importStatus');
      
      // Show loading status
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#2f2f1a';
      statusDiv.style.border = '1px solid #ff9800';
      statusDiv.style.color = '#ff9800';
      statusDiv.textContent = 'Importing data...';

      worksheetTracker.importFromFile(file)
        .then(result => {
          if (result.success) {
            statusDiv.style.background = '#1a2f1a';
            statusDiv.style.border = '1px solid var(--accent-color)';
            statusDiv.style.color = 'var(--accent-color)';
            statusDiv.textContent = result.message + ' Refreshing...';
            
            // Clear the file input
            input.value = '';
            
            // Refresh the page
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            throw new Error(result.message);
          }
        })
        .catch(error => {
          statusDiv.style.background = '#2f1a1a';
          statusDiv.style.border = '1px solid #f44336';
          statusDiv.style.color = '#f44336';
          statusDiv.textContent = 'Import failed: ' + error.message;
          
          // Clear the file input
          input.value = '';
        });
    }

    // Reset options functions
    function showResetOptions() {
      const resetOptions = document.getElementById('resetOptions');
      const initialBtn = document.getElementById('initialResetBtn');
      
      // Show options with animation
      resetOptions.style.display = 'flex';
      resetOptions.classList.add('show');
      
      // Disable initial button
      initialBtn.disabled = true;
      initialBtn.style.opacity = '0.5';
      
      // Add escape key listener
      document.addEventListener('keydown', handleEscapeKey);
    }

    function hideResetOptions() {
      const resetOptions = document.getElementById('resetOptions');
      const initialBtn = document.getElementById('initialResetBtn');
      
      // Hide options with animation
      resetOptions.classList.remove('show');
      
      // Re-enable initial button
      initialBtn.disabled = false;
      initialBtn.style.opacity = '1';
      
      // Remove escape key listener
      document.removeEventListener('keydown', handleEscapeKey);
      
      // Hide options after animation
      setTimeout(() => {
        resetOptions.style.display = 'none';
      }, 300);
    }
    
    function handleEscapeKey(event) {
      if (event.key === 'Escape') {
        hideResetOptions();
      }
    }

    function exportAndReset() {
      // Export current progress
      exportToJSON();
      
      // Wait a brief moment to ensure export completes
      setTimeout(() => {
        resetProgress();
      }, 500);
    }

    function resetProgress() {
      // Clear all progress data
      worksheetTracker.clearAllProgress();
      
      // Update the UI
      updateQuickStats();
      updateWorksheetsDisplay();
      initializeCharts();
      
      // Hide the reset options
      hideResetOptions();
      
      // Show success message
      const statusDiv = document.createElement('div');
      statusDiv.className = 'inline-notification success';
      statusDiv.innerHTML = `
        <div class="notification-title">Progress Reset Successfully</div>
        <div class="notification-message">All worksheet progress has been cleared.</div>
      `;
      document.body.appendChild(statusDiv);
      
      // Remove the notification after 3 seconds
      setTimeout(() => {
        statusDiv.classList.add('fade-out');
        setTimeout(() => {
          statusDiv.remove();
        }, 300);
      }, 3000);
    }

    // Refresh dashboard every 30 seconds
    setInterval(() => {
      updateQuickStats();
      updateWorksheetsDisplay();
    }, 30000);
  </script>
</body>
</html> 